---
title: "ErBr_report"
author: "Michelle DePrenger-Levin"
date: "October 31, 2016"
output: html_document
---
Clean slate
```{r}
rm(list=ls(all=TRUE))

```

###Packages
```{r}
library(prism)
library(ggplot2)
library(raster)
library(plotrix)
library(devtools)
library(RCurl)
library(scales)
library(car)
library(lme4)
require(AICcmodavg)
library(lattice)
library(patchwork)
library(dplyr)
library(tidyr)
library(MASS)
```


Functions   
```{r}
# StagePVA_Function.R
script <- getURL("https://raw.githubusercontent.com/DenverBotanicGardens/ErBr/master/CountPVA.R",
                 ssl.verifypeer = FALSE)
eval(parse(text = script))


## After add new climate data once:
load("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/2022_Eriogonum-brandegeei/erbrseasons.Rdata")

load("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/2022_Eriogonum-brandegeei/climatelong.Rdata")

```

###Data    
Download Raw Data and and Summary Table
<https://research.botanicgardens.org/admin/>
```{r}
currentyr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))
# Michelle's path
myUsername <- "deprengm"

erbr.raw <- read.csv(paste("C:/Users/",myUsername,"/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_Data/rawdata_",
                           currentyr,".csv", sep=""))

erbr.summary <- read.csv(paste("C:/Users/",myUsername,"/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_Data/summarytable_",
                           currentyr,".csv", sep=""))

erbr.cleora <- erbr.summary[erbr.summary$Site == "Cleora" & erbr.summary$Year == 2004,]
erbr.summary <- erbr.summary[erbr.summary$Site != "Cleora",]
erbr.summary$Site <- factor(erbr.summary$Site)


#Table 1
erbr.summary[erbr.summary$Year == currentyr,]
erbr.summary[order(erbr.summary$Site, erbr.summary$Transect, erbr.summary$Year),]

# Rust in how many years of the total
# total
length(2004:currentyr)
#years with rust
table(erbr.summary$Year[erbr.summary$Rust>0], erbr.summary$Rust[erbr.summary$Rust>0])
```

# Climate Data
just use the data downloaded for AsMi
```{r}
prism_set_dl_dir("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")
#Precipitation total, rain and snow
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)
#Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)
#Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

get_prism_monthlys(type = "vpdmax", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)
```
cleanup
```{r}

get_prism_monthlys(type="ppt", mon = 1:7, keepZip = FALSE, years = currentyr)
#Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:7, keepZip = FALSE, years = currentyr)
#Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:7, keepZip = FALSE, years = currentyr)
get_prism_monthlys(type="tmin", mon = 12, keepZip = FALSE, years = 2021)

```


```{r}
erbrlatlong <- data.frame(Lat = 38.5434, Long = -105.2184)

maxs <- prism_archive_subset(type = "tmax", temp_period = "monthly")
mins <- prism_archive_subset(type = "tmin", temp_period = "monthly")
ppt <- prism_archive_subset(type = "ppt", temp_period = "monthly")
wvdm <- prism_archive_subset(type = "vpdmax", temp_period = "monthly")
length(maxs) # 490, 510
length(mins) # 490
length(ppt) # 490

avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(pd_to_file(x))
  data.frame(data = raster::extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = x)
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(pd_to_file(x))
  data.frame(data = raster::extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = x)
})

avgPrecip <- lapply(ppt, function(x){
  rastertemps <- raster(pd_to_file(x))
  data.frame(data = raster::extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = x)
})

avgwvdm <- lapply(wvdm, function(x){
  rastertemps <- raster(pd_to_file(x))
  data.frame(data = raster::extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = x)
})

mins.avg <- do.call(rbind, avgTemps.min)
maxs.avg <- do.call(rbind, avgTemps.max)
ppt.avg <- do.call(rbind, avgPrecip)
wvdm.avg <- do.call(rbind, avgwvdm)

erbr.climate.monthly <- ppt.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep")  %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value) %>%
  dplyr::rename(Year = Prev12)

## Check running up to Prev12
table(erbr.climate.monthly$Year, erbr.climate.monthly$Month)


erbr.climate.monthly.tmin <- mins.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.tmin$Year, erbr.climate.monthly.tmin$Month) # missing December 2021
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value) %>%
  dplyr::rename(Year = Prev12)

erbr.climate.monthly.tmax <- maxs.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.tmin$Year, erbr.climate.monthly.tmin$Month) # missing December 2021
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value) %>%
  dplyr::rename(Year = Prev12)

erbr.climate.monthly.wvdm <- wvdm.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.wvdm$Year, erbr.climate.monthly.wvdm$Month) 
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value) %>%
  dplyr::rename(Year = Prev12)

erbr.seasons <- erbr.climate.monthly %>%
  left_join(erbr.climate.monthly.tmin, by = "Year") %>%
  left_join(erbr.climate.monthly.tmax, by = "Year") %>%
  left_join(erbr.climate.monthly.wvdm, by = "Year") %>%
  filter(Year < 2023 & Year > 2003)

save(erbr.seasons, file = "C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/2022_Eriogonum-brandegeei/erbrseasons.Rdata")

wbdm.long <- wvdm.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.wvdm$Year, erbr.climate.monthly.wvdm$Month) 
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep")

max.long <- maxs.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.tmin$Year, erbr.climate.monthly.tmin$Month) # missing December 2021
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") 

tmin.long <- mins.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.tmin$Year, erbr.climate.monthly.tmin$Month) # missing December 2021
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") 

ppt.long <- ppt.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep")

climate.long <- wbdm.long %>%
  bind_rows(max.long) %>%
  bind_rows(tmin.long) %>%
  bind_rows(ppt.long) %>%
  dplyr::rename(Year = Prev12)

save(climate.long, file ="C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/2022_Eriogonum-brandegeei/climatelong.Rdata")
```

Demography     
    
    Was "SumOfRosettes"

Figure 2
```{r}
ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_Fig2.jpg", sep=""),
  ggplot(erbr.summary, aes(Year, SumOfRosettes  ,colour = Site, shape = Site))+
    stat_summary(fun = mean, position=position_dodge(width=0.5),
                 fun.min = function(x) mean(x) - std.error(x),
                 fun.max = function(x) mean(x) + std.error(x),
                 geom = "errorbar")+
     stat_summary(fun = mean, position=position_dodge(width=0.5),
                 fun.min = function(x) mean(x) - std.error(x),
                 fun.max = function(x) mean(x) + std.error(x),
                 geom = "point")+
    stat_summary(fun = mean,
                 geom = "line")+
    theme_bw() +
    ylab("Average rosettes per transect")+
    scale_color_manual(values=c("#000000","#7e7e7e"),
                       labels = c("Garden Park East","Garden Park West"))+
    scale_shape_manual(values=c(1,2),
                       labels = c("Garden Park East","Garden Park West"))+
    theme(legend.justification=c(1,1), legend.position=c(0.85,1), legend.background = element_blank()) ,
width=250, height=125,units='mm', dpi=300)
  
```

Count PVA
```{r}
gpe.summary <- aggregate(SumOfRosettes ~ Year,
                         data = erbr.summary[erbr.summary$Site == "Garden Park East",], mean)
gpw.summary <- aggregate(SumOfRosettes ~ Year,
                         data = erbr.summary[erbr.summary$Site == "Garden Park West",], mean)

GPE <- CountPVA(gpe.summary, "Year","SumOfRosettes")
GPW <- CountPVA(gpw.summary, "Year","SumOfRosettes")

sapply(GPE[,1:3], function(x) exp(x))
sapply(GPW[,1:3], function(x) exp(x))
```

Figure 3a
```{r}

fig3a <- 
  ggplot(erbr.summary, aes(Year, SumOfInfl,colour = Site, shape = Site))+
    stat_summary(fun = mean, position=position_dodge(width=0.5),
                 fun.min = function(x) mean(x) - std.error(x),
                 fun.max = function(x) mean(x) + std.error(x),
                 geom = "errorbar")+
     stat_summary(fun = mean, position=position_dodge(width=0.5),
                 fun.min = function(x) mean(x) - std.error(x),
                 fun.max = function(x) mean(x) + std.error(x),
                 geom = "point")+
    stat_summary(fun = mean, position=position_dodge(width=0.5),
                 geom = "line")+
    theme_bw() +
    ggtitle("a)") +
    theme(plot.title=element_text(hjust=0))+
    ylab("Average inflorescences per transect")+
    scale_color_manual(values=c("#000000","#7e7e7e"),
                       labels = c("Garden Park East","Garden Park West"))+
    scale_shape_manual(values=c(1,2),
                       labels = c("Garden Park East","Garden Park West"))+
    theme(legend.justification=c(1,1), legend.position=c(1,1),legend.background = element_blank())

```

Figure 3b
```{r}

# inflorescences per rosette
erbr.summary$InflperRos <- erbr.summary$SumOfInfl/erbr.summary$SumOfRosettes
erbr.summary$InflperRos[is.na(erbr.summary$InflperRos)] <- 0

fig3b <- ggplot(erbr.summary, aes(Year, InflperRos,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Average inflorescences per rosettes")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 


ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",
                        currentyr,"_Fig3ab.jpg", sep=""), 
       fig3a + fig3b,
 width=200, height=75,units='mm', dpi=300)
```

# Demography
Averages before and after 2011
```{r}
# Garden Park West remained significantly smaller in years after 2011
erbr.summary %>%
  mutate(PrePost2011 = case_when(Year >= 2011 ~ "post",
                                 Year < 2011 ~ "pre")) %>%
  group_by(Site, PrePost2011) %>%
  summarise(Mean = mean(SumOfRosettes), sd= sd(SumOfRosettes))

table(erbr.raw$Site, erbr.raw$Year)

erbr.summary %>%
  filter(SumOfRosettes > 0) %>%
ggplot( aes(Year, SumOfRosettes, color = Site, linetype = as.factor(Transect)))+
  geom_line()+
  geom_point()+
  theme_bw()
```

#Really? Those are defined as drought how?
```{r}

erbr.summary %>%
  mutate(drought = case_when(Year >= 2011 ~ "post",
                                 Year < 2011 ~ "pre")) %>%
  group_by(Site, drought) %>%
  mutate(SumOfRosettesmean = mean(SumOfRosettes), SD= sd(SumOfRosettes), SE = std.error(SumOfRosettes)) %>%
ggplot( aes(drought,SumOfRosettesmean, colour = Site))+
  geom_point(position = position_dodge(width = 0.1))+
  geom_errorbar(aes(ymax=SumOfRosettesmean + SE, ymin=SumOfRosettesmean - SE), width=0.1, position = position_dodge(width = 0.1))+
  theme_bw()+
  xlab("Drought conditions (2011-2013)")+
  ylab("Average rosettes")+
  scale_color_manual(values=c("black","grey70"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank())

cliamte.long <- climate.long %>%
  group_by(Variable) %>%
  mutate(scale_value = scale(Value))

ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_climate.jpg", sep = ""),
climate.long %>%
  group_by(Variable) %>%
  mutate(scale_value = scale(Value)) %>%
ggplot(  aes(Year, scale_value, color = Variable))+
  geom_line()+
  geom_point()+
  theme_bw()+
  facet_grid(season ~ Variable, scales = "free")+
  ylab("scaled and centered")+
  stat_smooth(method = "lm")+
  scale_color_discrete(guide = "none")+
  ggtitle("a)")+
  geom_hline(yintercept = 0, col="grey30", linetype = "dotted"),
width=250, height=125,units='mm', dpi=300)

summary(lm(Value ~ Year + season, data = climate.long[climate.long$Variable == "vpdmax",]))

ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_climate_studyperiod.jpg", sep = ""),
climate.long %>%
  group_by(Variable) %>%
  mutate(scale_value = scale(Value)) %>%
  filter(Year > 2003) %>%
ggplot(  aes(Year, scale_value, color = Variable))+
  geom_line()+
  geom_point()+
  theme_bw()+
  facet_grid(season ~ Variable, scales = "free")+
  ylab("scaled and centered")+
  stat_smooth(method = "lm")+
  scale_color_discrete(guide = "none")+
  ggtitle("b)")+
  geom_hline(yintercept = 0, col="grey30", linetype = "dotted"),
width=250, height=125,units='mm', dpi=300)
```

Figure 5a
```{r}

fig5a <- ggplot(erbr.summary, aes( Year,SumOfArea,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average basal area (cm"^2~") per transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

```

Figure 5b
```{r}

erbr.summary$RosperArea <- erbr.summary$SumOfRosettes/erbr.summary$SumOfArea

# jpeg(paste0("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/",currentyr,"_ErBr/Fig5b.jpg"),
#      width=120, height=100,units='mm', res=300)

fig5b <- ggplot(erbr.summary, aes(Year,RosperArea,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average rosettes per basal area (cm"^2~")"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

# dev.off()

```

Figure 5c
```{r}

erbr.summary$InflperArea <- erbr.summary$SumOfInfl/erbr.summary$SumOfArea

# jpeg(paste0("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/",currentyr,"_ErBr/Fig5c.jpg"),
#      width=120, height=100,units='mm', res=300)

fig5c <- ggplot(erbr.summary, aes(Year,InflperArea,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average inflorescences per basal area (cm"^2~")"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 


ggsave(filename = paste("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/",currentyr,"_ErBr/Fig5abc.jpg", sep=""), 
       (fig5a | fig5b)/(fig5c | plot_spacer()),
 width=240, height=200,units='mm', dpi=300)

```

Figure 6a
```{r}


fig6a <- ggplot(erbr.summary, aes(Year,SumOfBrowsedInfl,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.25),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.25),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.25),
               geom = "line")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Average browsed inflorescences per transect")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 


```

Figure 6b
```{r}

erbr.summary$InflBrperInfl <- erbr.summary$SumOfBrowsedInfl/erbr.summary$SumOfInfl

fig6b <- ggplot(erbr.summary, aes(Year,InflBrperInfl,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.25),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.25),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.25),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Percent browsed inflorescences")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0,1), legend.position=c(0,1), legend.background = element_blank()) +
  scale_y_continuous(labels = percent)


ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_Fig6ab.jpg", sep=""), 
       fig6a + fig6b,
 width=240, height=100,units='mm', dpi=300)
```


Figure 4
```{r}
precip <- aggregate(ppt~Prev12,
                    data = erbr.c, sum)

erbr.seasons %>%
  

mean(precip$ppt)

fig4a <- ggplot(precip[precip$Prev12>1994&precip$Prev12<=currentyr,], aes(Prev12, ppt))+
  geom_line()+
  geom_hline(linetype = "dashed", aes(yintercept = mean(ppt)))+
  annotate("text", x=1998, y=mean(precip$ppt)-5, label=paste(round(mean(precip$ppt),0),"mm", sep=""))+
  theme_bw()+
  geom_rect(aes(xmin=-Inf,xmax=2003.5,
                ymin=-Inf, ymax=Inf),
            fill= "grey", alpha = 0.03)+
  scale_x_continuous(breaks = seq(1995,currentyr,by = 2))+
  ylab("Annual precipition (mm previous Aug-Jul)")+
  xlab("Survey year")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))

#figure 4b

mintemp <- aggregate(tmin~Prev12,
                     data = erbr.c, mean)

mintemp <- mintemp[mintemp$Prev12>1994&mintemp$Prev12<=currentyr,]

meantempmin <- mean(mintemp$tmin)

fig4b <- ggplot(mintemp, aes(Prev12, tmin))+
  geom_line()+
  geom_hline(linetype = "dashed", aes(yintercept = mean(tmin)))+
  annotate("text", x=1995, y=mean(mintemp$tmin)+0.06, label=bquote(.(round(meantempmin,1)))) +
  theme_bw()+
  geom_rect(aes(xmin=-Inf,xmax=2003.5,
                ymin=-Inf, ymax=Inf),
            fill= "grey", alpha = 0.03)+
  scale_x_continuous(breaks = seq(1995,currentyr,by = 2))+  
  ylab(expression("Average minimum temperature ("~degree*C~"previous Aug-Jul)"))+
  xlab("Survey year")+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))

```

## New figure 4 being all climate data and study period data

figure 4c
```{r}


maxtemp <- maxtemp[maxtemp$Prev12>1994&maxtemp$Prev12<=currentyr,]
meantempmax <- mean(maxtemp$tmax)

fig4c <- ggplot(maxtemp, aes(Prev12, tmax))+
  geom_line()+
  geom_hline(linetype = "dashed", aes(yintercept = mean(tmax)))+
  annotate("text", x=1994.7, y=mean(maxtemp$tmax)+0.09, 
           label= bquote(.(round(meantempmax,1)))) +   #~degree*C
  theme_bw()+
  geom_rect(aes(xmin=-Inf,xmax=2003.5,
                ymin=-Inf, ymax=Inf),
            fill= "grey", alpha = 0.03)+
  scale_x_continuous(breaks = seq(1995,currentyr,by = 2))+
  ylab(expression("Average maximum temperature ("~degree*C~"previous Aug-Jul)"))+
  xlab("Survey year")+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))


ggsave(filename = paste("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/",currentyr,"_ErBr/Fig4abc.jpg", sep=""), 
       # (fig4a | fig4b)/(fig4c | plot_spacer()),
       fig4a + fig4b + fig4c + plot_layout(ncol = 2),
 width=240, height=200,units='mm', dpi=300)
```


```{r}

# Fill in missing years with climate but no data

missingyears <- setdiff(c(min(unique(erbr.summary$Year)):max(unique(erbr.summary$Year))),
                        unique(erbr.summary$Year))

for(yr in missingyears){
  addrows <- erbr.summary[erbr.summary$Year == 2013,]
  addrows[,3:8] <- lapply(addrows[,3:8], function(x) x <- NA)
  addrows$Year <- yr
  erbr.summary <- rbind(erbr.summary, addrows)
}

erbr.all <- merge(erbr.summary,erbr.seasons, by = "Year")
```



## AIC 

# Dredge for everything or: Think through what might be impacting rosettes. Maybe multiple years of drought and rust or just current or just past climate or interaction of a couple years in a row of climate.   
```{r}
library(jtools)
library(lme4)

pairs(erbr.seasons)
cor.climate <- as.data.frame(as.table(cor(erbr.seasons[,-1])))
cor.climate[abs(cor.climate$Freq) > 0.7,]

exclude <- c("ppt_fall","tmax_fall","ppt_summer","tmax_summer","tmax_winter")
keep <- c("vpdmax_fall","vpdmax_summer","tmin_fall","vpdmax_winter")

erbr.all[,!(names(erbr.all) %in% exclude)]
erbr.all$SiteTran <- paste(erbr.all$Site,erbr.all$Transect,sep="")
erbr.lms <- erbr.all[erbr.all$SumOfRosettes >0,!(names(erbr.all) %in% exclude)]
lm1 <- glmer(SumOfRosettes ~ vpdmax_fall + vpdmax_summer + tmin_fall + vpdmax_winter + (Year|SiteTran), 
              data = erbr.lms, family = poisson(link = "log"))
lm2 <- glmer(SumOfRosettes ~ vpdmax_summer + (1+Year|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm3 <- glm(SumOfRosettes ~ vpdmax_summer, 
              data = erbr.lms, family = poisson(link = "log"))
lm4 <- glm(SumOfRosettes ~ vpdmax_summer, 
              data = erbr.lms, family = poisson(link = "log"))
lm5 <- glm(SumOfRosettes ~ vpdmax_summer, 
              data = erbr.lms, family = poisson(link = "log"))
lm6 <- glm(SumOfRosettes ~ 1, 
              data = erbr.lms, family = poisson(link = "log"))



lm.list <- list(lm1,lm6, lm7,lm8,lm9,lm14,lm15,lm16,lm18)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

evidence(lm.results)

## correct standard error? Compare with quasipoisson
lm1a <- glm(SumOfRosettes ~ vpdmax_fall + vpdmax_summer + tmin_fall + vpdmax_winter, 
              data = erbr.lms, family = quasipoisson(link = "log"))
plot_summs(lm1, lm1a, scale = TRUE, plot.distributions = TRUE)
effect_plot(lm1a, pred = vpdmax_fall, interval = TRUE)
effect_plot(lm1a, pred = vpdmax_fall, interval = TRUE)
## predictions generated
effect_plot(lm1a, pred = vpdmax_winter, interval = TRUE, plot.points = TRUE)
effect_plot(lm1a, pred = tmin_fall, interval = TRUE, plot.points = TRUE)
effect_plot(lm1a, pred = vpdmax_winter, interval = TRUE, plot.points = TRUE)
effect_plot(lm1a, pred = vpdmax_summer, interval = TRUE, plot.points = TRUE)


```

# AICc rosettes
```{r}
head(erbr.all)

# current year can't change the number of rosettes but rust might be associated with more growth, a sign of better conditions for the plant
glm1 <- glm.nb(SumOfRosettes~as.factor(RustYN), erbr.all)
summary(glm1)
glm1$theta
ggplot(erbr.all, aes(as.factor(RustYN), SumOfRosettes))+
  geom_boxplot()

#climate in the current year
glm2 <- glm.nb(SumOfRosettes~ppt, erbr.all)
glm3 <- glm.nb(SumOfRosettes~tmin, erbr.all)
glm4 <- glm.nb(SumOfRosettes~tmax, erbr.all)
glm5 <- glm.nb(SumOfRosettes~(ppt*tmin*tmax), erbr.all)

# All climate interacting with rust
# glm14 <- glm.nb(SumOfRosettes~ppt*as.factor(RustYN), erbr.all)
# glm15 <- glm.nb(SumOfRosettes~tmin*as.factor(RustYN), erbr.all)
# glm16 <- glm.nb(SumOfRosettes~tmax*as.factor(RustYN), erbr.all)

# Null model
glm18 <- glm.nb(SumOfRosettes~1, erbr.all)

lm.list <- list(glm1,glm2, glm3, glm4, glm5,
                # glm14,glm15,glm16,
                glm18)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

```

zero inflation
```{r}
# install.packages("pscl")
library(pscl)

?zeroinfl

```

# What is reproduction correlated to?  
```{r}
# AICc
# lm1 <- lm(SumOfRosettes.x~Site, erbr.all.t1) # They are so close and similar, wouldn't assume differences between macroplots
rm(lm1);rm(lm2);rm(lm3);rm(lm4);rm(lm5);rm(lm6);rm(lm14);rm(lm15);rm(lm16);rm(lm18)

# current year can't change the number of rosettes
lm1 <- glm.nb(SumOfInfl.y ~as.factor(RustYN.x), erbr.all.t1[erbr.all.t1$Year.y < 2014,])

#climate in the current year
lm2 <- glm.nb(SumOfInfl.y~ppt.y, erbr.all.t1[erbr.all.t1$Year.y < 2014,])
lm3 <- glm.nb(SumOfInfl.y~tmin.y, erbr.all.t1[erbr.all.t1$Year.y < 2014,])
lm4 <- glm.nb(SumOfInfl.y~tmax.y, erbr.all.t1[erbr.all.t1$Year.y < 2014,])
lm5 <- glm.nb(SumOfInfl.y~(ppt.y*tmin.y*tmax.y), erbr.all.t1[erbr.all.t1$Year.y < 2014,])

# All climate interacting with rust
lm14 <- glm.nb(SumOfInfl.y~ppt.y*as.factor(RustYN.x), erbr.all.t1[erbr.all.t1$Year.y < 2014,])
lm15 <- glm.nb(SumOfInfl.y~tmin.y*as.factor(RustYN.x), erbr.all.t1[erbr.all.t1$Year.y < 2014,])
lm16 <- glm.nb(SumOfInfl.y~tmax.y*as.factor(RustYN.x), erbr.all.t1[erbr.all.t1$Year.y < 2014,])
# lm17 <- lm(SumOfRosettes~(ppt.y+tmin.y+tmax.y+as.factor(RustYN.y))^2, erbr.all.t1[erbr.all.t1$Year.y < 2014,])

# Null model
lm18 <- glm.nb(SumOfInfl.y~1, erbr.all.t1[erbr.all.t1$Year.y < 2014,])



lm.list <- list(lm1,lm2, lm3, lm4, lm5,
                lm14,lm15,lm16,
                lm18)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

ggplot(erbr.all.t1, aes(ppt.y, SumOfInfl.y, colour = as.factor(RustYN.x)))+
  geom_point()+
  stat_smooth(method = "lm")


ggplot(erbr.all, aes(ppt, SumOfInfl, colour = tmin, size = tmax))+
  geom_point()+
  stat_smooth(method="lm")

ggplot(erbr.all, aes(tmin, SumOfInfl, colour = ppt, size = tmax))+
  geom_point()+
  stat_smooth(method="lm")

ggplot(erbr.all, aes(tmax, SumOfInfl, colour = tmin, size = ppt))+
  geom_point()+
  stat_smooth(method="lm")

evidence(lm.results)


```


```{r}
ggplot(erbr.all, aes(tmin, sinsqInflBrperInfl, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab(expression("Minimum temperature"~degree*C))+
  theme_bw() +
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Proportion of browsed inflorescences"["  arcsine square root"]*" by transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha(0.4))) 

```


#Figure 7 as one
```{r}

# op <- par(no.readonly = TRUE)

#Plot 1 7a
fig7a <- ggplot(erbr.all, aes(tmax, SumOfRosettes, colour = Site))+
  geom_point()+
  # stat_smooth(method = "glm", formula = y ~ log(x))+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("")+
  # xlab(expression("Maximum temperature"~degree*C))+
  ylab("Rosettes per transect")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha(0.9))) 

# Plot 2 7a second
fig7a2 <- ggplot(erbr.all, aes(ppt, SumOfRosettes, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("")+
  # xlab("Precipitation mm")+
  ylab("")+
  theme_bw() +
  ggtitle("") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0.21,1), legend.position=c(0.21,1),
        legend.background = element_rect(fill=alpha(0.9))) 

# plot 3
fig7b <-ggplot(erbr.all, aes(tmax, logSumOfInfl, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("")+
  # xlab(expression("Minimum temperature"~degree*C))+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Inflorescences"["  log"]*" per transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha(0.9))) 

# plot 4
fig7b2 <-ggplot(erbr.all, aes(ppt, logSumOfInfl, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("")+
  # xlab("Precipitation mm")+
  theme_bw() +
  ggtitle("") +
  theme(plot.title=element_text(hjust=0))+
  ylab("")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha(0.9))) 

fig7c <-ggplot(erbr.all, aes(tmax, sinsqInflperRos, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab(expression("Maximum temperature"~degree*C))+
  theme_bw() +
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Inflorescences per rosette  "[sqrt("arcsine")]~"by transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha(0.8))) 

fig7c2 <-ggplot(erbr.all, aes(ppt, sinsqInflperRos, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Precipitation mm")+
  theme_bw() +
  ggtitle("") +
  theme(plot.title=element_text(hjust=0))+
  ylab("")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0,1), legend.position=c(0,1),
        legend.background = element_rect(fill=alpha(0.9))) 


ggsave(filename = paste("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/",currentyr,"_ErBr/Fig7abc.jpg", sep=""),
       fig7a + fig7a2 + fig7b + fig7b2 + fig7c +fig7c2 + plot_layout(ncol =2),
width=250, height=310,units='mm', dpi=300)
  


```



log transformed sum of inflorescences
```{r}
lmer(logSumOfInfl ~ tmin + (1|Site), data = erbr.all)
summary(lm(logSumOfInfl ~ tmin, data = erbr.all))

summary(lm(logSumOfInfl ~ ppt, data = erbr.all))
```


transformed inflorescence per rosette
```{r}
lmer(sinsqInflperRos ~ tmin + (1|Site), data = erbr.all)

summary(lmer(sinsqInflperRos ~ tmin + (1|Site), data = erbr.all))

summary(lm(sinsqInflperRos ~ tmin, data = erbr.all))


summary(lm(sinsqInflperRos ~ ppt, data = erbr.all))
```

# More Results
transformed browsed inflorescences per total inflor   
Only get years 2005 through 2013 since after that we skipped 2 or 1 year  
```{r}

# Rust should be a yes or no
erbr.all$RustYN <- 0 
erbr.all$RustYN[erbr.all$Rust>0] <- 1

erbr.all.t1 <- subset(merge(erbr.all, erbr.all, by = c("Site","Transect")), Year.x == Year.y-1)



lmer(sinsqInflBrperInfl ~ tmin + (1|Site), data = erbr.all)

summary(lmer(sinsqInflBrperInfl ~ tmin + (1|Site), data = erbr.all))

summary(lm(sinsqInflBrperInfl ~ tmin, data = erbr.all))


summary(lm(sinsqInflBrperInfl ~ ppt, data = erbr.all))

agg.erbrbrowse <- aggregate(SumOfBrowsedInfl ~ Site + drought, data=erbr.summary, mean)
agg.erbrbrowse$Sd <- aggregate(SumOfBrowsedInfl ~ Site + drought, data=erbr.summary, sd)[,3]
agg.erbrbrowse

# Percent of browsed inflorescences
lapply(split(erbr.summary, erbr.summary$Site), function(x){
  avgout <- aggregate(SumOfBrowsedInfl ~ Year , data=x, mean)
  sdout <- aggregate(SumOfBrowsedInfl ~ Year , data=x, sd)
  avgout <- data.frame(avgout,sdout)
  avgout[avgout[,2]==max(avgout[,2]),]
})

aggregate(SumOfBrowsedInfl ~ Site , data=erbr.summary, mean)
aggregate(SumOfBrowsedInfl ~ Site , data=erbr.summary, sd)


# Rust?
lapply(split(erbr.summary, erbr.summary$Site), function(x){
  avgout <- aggregate(Rust ~ Year , data=x, mean)
  sdout <- aggregate(Rust ~ Year , data=x, sd)
  avgout <- data.frame(avgout,sdout)
  avgout[avgout[,2]==max(avgout[,2]),]
})

hist(erbr.all$Rust)
hist(log(erbr.all$Rust))
hist(erbr.all.t1$SumOfRosettes.x)
hist(log(erbr.all.t1$logSumOfRosettes.x + 1))

# What are in same distribution, normally distributed? 
# use a Kolmogorov-Smirnov test to determine if the data is from a normal distribution
ks.test(erbr.all$SumOfRosettes, rnorm(50)) # p-val < 0.0001 means low prob that came from a normal distribution
ks.test(log(erbr.all$SumOfRosettes + 1), rnorm(50)) # p-val < 0.0001 means low prob that came from a normal 


qqnorm(erbr.all$SumOfRosettes)
qqline(erbr.all$SumOfRosettes)

qqnorm(log(erbr.all$SumOfRosettes +1))
qqline(log(erbr.all$SumOfRosettes +1))


qqnorm(erbr.all$InflperRos)
qqline(erbr.all$InflperRos)


qqnorm(erbr.all$InflperArea)
qqline(erbr.all$InflperArea)

qqnorm(erbr.all$SumOfInfl)
qqline(erbr.all$SumOfInfl)

qqnorm(erbr.all$logSumOfInfl)
qqline(erbr.all$logSumOfInfl)

qqnorm(log(erbr.all$SumOfRosettes +1))
qqline(log(erbr.all$SumOfRosettes +1))

ks.test(erbr.all$Rust, rnorm(50)) # p-val < 0.0001 means low prob that came from a normal distribution

qqnorm(erbr.all$Rust)
qqline(erbr.all$Rust)


```



ppt and tmax more than ppt and tmin so keep tmin. but they are 71% so could keep both 
```{r}
erbr.all$ppt100 <- erbr.all$ppt/100
step.lm <- step(lm(logSumOfRosettes ~ (ppt+tmin+tmax)^2, data = erbr.all))

#Check for Multi-collinearity
vif(step.lm) #Variance inflation factors
sqrt(vif(step.lm)) > 2 # means a problem, so all are a problem

#Remove tmax and keep going
twolm <- lm(logSumOfRosettes ~ (ppt+tmin)^2, data = erbr.all)
vif(twolm)

step.lm <- step(lm(logSumOfRosettes ~ (ppt+tmin)^2, data = erbr.all))

summary(step.lm)
```

tmin only signficant one
```{r}
erbr.all$sinsqInflperRos
erbr.all$logSumOfInfl

summary(lm(logSumOfRosettes~tmin, data=erbr.all))

twoInfo <- lm(logSumOfInfl~(ppt+tmin)^2, data=erbr.all)
vif(twoInfo)

summary(lm(logSumOfInfl~tmin, data=erbr.all))

summary(lm(logSumOfInfl~ppt, data=erbr.all))


```


```{r}
step.lmsmall <- step(lm(logSumOfRosettes ~ (ppt+tmin)^2, data = erbr.all))
summary(step.lmsmall)

summary(lm(logSumOfRosettes~tmin, data=erbr.all))
summary(lm(logSumOfRosettes~tmax, data=erbr.all))
summary(lm(logSumOfRosettes~ppt, data=erbr.all))
```

#Precip not signficant but what does it look like?
```{r}
ggplot(erbr.all, aes(ppt, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Total precipitation (previous 12 months)")+
  ylab("Rosettes per transect")

```

```{r}
ggplot(erbr.all, aes(tmin, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab(expression("Minimum temperature"~degree*C))+
  ylab("Rosettes per transect")

```


```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(ppt, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Total precipitation (previous 12 months)")+
  ylab("Rosettes per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmin  <= mean(erbr.all$tmin),], aes(ppt, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Total precipitation (previous 12 months)")+
  ylab("Rosettes per transect")

```


```{r}
ggplot(erbr.all[erbr.all$tmax > mean(erbr.all$tmax),],aes(tmin, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly minimum temperature (previous 12 months)")+
  ylab("Rosettes per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmax <= mean(erbr.all$tmax),], aes(tmin, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly minimum temperature (previous 12 months)")+
  ylab("Rosettes per transect")

```

Maximum temperatre given above and below minimum temperature
```{r}
ggplot(erbr.all[erbr.all$tmin <= mean(erbr.all$tmin),], aes(tmax, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Rosettes per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(tmax, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Rosettes per transect")

```

## Inflorescences
```{r}

ggplot(erbr.all[erbr.all$tmin <= mean(erbr.all$tmin),], aes(tmax, SumOfInfl))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(tmax, SumOfInfl))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per transect")

```


## Inflorescences
```{r}

ggplot(erbr.all[erbr.all$tmin <= mean(erbr.all$tmin),], aes(tmax, SumOfInfl))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(tmax, SumOfInfl))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per transect")

```


#InflperRos
```{r}

ggplot(erbr.all[erbr.all$tmin <= mean(erbr.all$tmin),], aes(tmax, InflperRos))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per rosettes")

```

```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(tmax, InflperRos))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per rosettes")

```

Appendix D:
```{r}
head(erbr.all)

appdD <- erbr.all[erbr.all$Year == 2016,
                  c("Site","Transect","Year","SumOfRosettes","SumOfInfl","SumOfArea",
                     "SumOfBrowsedInfl","Rust")]
```

For Becky, annual report 01232018
```{r}
erbr_yr <- aggregate(Rosettes~Year, data=erbr.summary, FUN=sum)

ggsave("Q:/Research/MEDL_folder/ErBr_yr.jpg",device="jpeg",
       ggplot(erbr_yr, aes(Year,Rosettes))+
         geom_line(colour="blue")+
         ggtitle("Eriogonum brandegeei")+
         theme_classic()+
         ylab("Total Population"))

write.csv(erbr_yr,"Q:/Research/MEDL_folder/ErBr_yr.csv" )

```
