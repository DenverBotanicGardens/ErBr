---
title: "ErBr_report"
author: "Michelle DePrenger-Levin"
date: "October 31, 2016"
output: html_document
---
Clean slate
```{r}
rm(list=ls(all=TRUE))

```

###Packages
```{r}
library(prism)
library(ggplot2)
library(raster)
library(plotrix)
library(devtools)
library(RCurl)
library(scales)
library(car)
library(lme4)
```


Functions   
```{r}
# StagePVA_Function.R
script <- getURL("https://raw.githubusercontent.com/DenverBotanicGardens/ErBr/master/CountPVA.R",
                 ssl.verifypeer = FALSE)
eval(parse(text = script))

```

###Data    
Download Raw Data and and Summary Table
<https://research.botanicgardens.org/admin/>
```{r}
currentyr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))
rawdatapath <- paste("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/", 
                     currentyr,"_ErBr/rawdata_",
                     currentyr, ".csv", collapse = '', sep = '')

erbr.raw <- read.csv(path.expand(rawdatapath), na.strings = "na")

summarypath <- paste("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/", 
                     currentyr,"_ErBr/summarytable_",
                     currentyr, ".csv", collapse = '', sep = '')
erbr.summary <- read.csv(path.expand(summarypath), na.strings = "na")

erbr.cleora <- erbr.summary[erbr.summary$Site == "Cleora" & erbr.summary$Year == 2004,]
erbr.summary <- erbr.summary[erbr.summary$Site != "Cleora",]
erbr.summary$Site <- factor(erbr.summary$Site)
```

# Climate Data
just use the data downloaded for AsMi
```{r}
options(prism.path = "Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")

erbrlatlong <- data.frame(Lat = 38.5434, Long = -105.2184)

maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
ppt <- grep("ppt", ls_prism_data(absPath = TRUE)[,2])

avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = ls_prism_data()[x,])
})

avgPrecip <- lapply(ppt, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = ls_prism_data()[x,])
})

mins.avg <- do.call(rbind, avgTemps.min)
maxs.avg <- do.call(rbind, avgTemps.max)
ppt.avg <- do.call(rbind, avgPrecip)

erbr.climate <- cbind(mins.avg,maxs.avg[,1],ppt.avg[,1])
names(erbr.climate) <- c("tmin","date","tmax","ppt")

#Pull out month and year
#date is a factor
erbr.climate$date <- as.character(erbr.climate$date)

#split by _ select the YYYYMM numbers
erbr.climate$Year <- as.numeric(substr(vapply(strsplit(erbr.climate$date, '_'), 
                                   function(x) x[5], character(1)), 1,4))
erbr.climate$Month <- as.numeric(substr(vapply(strsplit(erbr.climate$date, '_'), 
                                   function(x) x[5], character(1)), 5,6))

erbr.c <- erbr.climate[,-2]
erbr.c$Prev12 <- erbr.c$Year
erbr.c$Prev12[erbr.c$Month > 7] <- erbr.c$Year[erbr.c$Month > 7]+1
```

```{r}
head(erbr.c)

plotppt <- aggregate(erbr.climate$ppt, by=list(erbr.climate$Year), "sum" )

ggplot(plotppt, aes(Group.1,x))+
  geom_line()+
  theme_bw()

mean(plotppt$x)
```

Demography     
    
    Was "SumOfRosettes"

Figure 2
```{r}
jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig2.jpg",
     width=250, height=125,units='mm', res=300)

ggplot(erbr.summary, aes(Year, SumOfRosettes,colour = Site, shape = Site))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean,
               geom = "line")+
  theme_bw() +
  ylab("Average rosettes per transect")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 
  
dev.off()
```

Count PVA
```{r}
gpe.summary <- aggregate(SumOfRosettes ~ Year,
                         data = erbr.summary[erbr.summary$Site == "Garden Park East",], mean)
gpw.summary <- aggregate(SumOfRosettes ~ Year,
                         data = erbr.summary[erbr.summary$Site == "Garden Park West",], mean)

GPE <- CountPVA(gpe.summary, "Year","SumOfRosettes")
GPW <- CountPVA(gpw.summary, "Year","SumOfRosettes")

sapply(GPE[,1:3], function(x) exp(x))
sapply(GPW[,1:3], function(x) exp(x))
```

Figure 3a
```{r}
jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig3a.jpg",
     width=100, height=75,units='mm', res=300)

ggplot(erbr.summary, aes(Year, SumOfInfl,colour = Site, shape = Site))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Average inflorescences per transect")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),legend.background = element_blank()) 

dev.off()
```

Figure 3b
```{r}

jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig3b.jpg",
     width=100, height=75,units='mm', res=300)
# inflorescences per rosette
erbr.summary$InflperRos <- erbr.summary$SumOfInfl/erbr.summary$SumOfRosettes
erbr.summary$InflperRos[is.na(erbr.summary$InflperRos)] <- 0

ggplot(erbr.summary, aes(Year, InflperRos,colour = Site, shape = Site))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Average inflorescences per rosettes")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

dev.off()

```

Averages before and after 2011
```{r}
erbr.summary$drought <- "before"
erbr.summary$drought[erbr.summary$Year > 2010] <- "after"
erbr.summary$drought <- factor(erbr.summary$drought, levels = c("before","after"))

agg.erbr <- aggregate(SumOfRosettes ~ Site + drought, data=erbr.summary, mean)
agg.erbr$SE <- aggregate(SumOfRosettes ~ Site + drought, data=erbr.summary, std.error)[,3]
```

#Really? Those are defined as drought how?
```{r}
ggplot(agg.erbr, aes(drought,SumOfRosettes, colour = Site))+
  geom_point()+
  geom_errorbar(aes(ymax=SumOfRosettes + SE, ymin=SumOfRosettes - SE), width=0.1)+
  theme_bw()+
  xlab("Drought conditions (2011-2013)")+
  ylab("Average rosettes")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank())

```

Figure 4a
```{r}
jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig4a.jpg",
     width=120, height=100,units='mm', res=300)

ggplot(erbr.summary, aes( Year,SumOfArea,colour = Site, shape = Site))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average basal area (cm"^2~") per transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

dev.off()
```

Figure 4b
```{r}
jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig4b.jpg",
     width=120, height=100,units='mm', res=300)

erbr.summary$RosperArea <- erbr.summary$SumOfRosettes/erbr.summary$SumOfArea

ggplot(erbr.summary, aes(Year,RosperArea,colour = Site, shape = Site))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average rosettes per basal area (cm"^2~")"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

dev.off()

```

Figure 4c
```{r}
jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig4c.jpg",
     width=120, height=100,units='mm', res=300)

erbr.summary$InflperArea <- erbr.summary$SumOfInfl/erbr.summary$SumOfArea

ggplot(erbr.summary, aes(Year,InflperArea,colour = Site, shape = Site))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average inflorescences per basal area (cm"^2~")"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

dev.off()

```

Figure 5a
```{r}

jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig5a.jpg",
     width=120, height=100,units='mm', res=300)

ggplot(erbr.summary, aes(Year,SumOfBrowsedInfl,colour = Site, shape = Site))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.25),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun.y = mean, position=position_dodge(width=0.25),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.25),
               geom = "line")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Average browsed inflorescences per transect")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

dev.off()
```

Figure 5b
```{r}
erbr.summary$InflBrperInfl <- erbr.summary$SumOfBrowsedInfl/erbr.summary$SumOfInfl

jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig5b.jpg",
     width=120, height=100,units='mm', res=300)

ggplot(erbr.summary, aes(Year,InflBrperInfl,colour = Site, shape = Site))+
  stat_summary(fun.y = mean, position=position_dodge(width=0.25),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun.y = mean, position=position_dodge(width=0.25),
               fun.ymin = function(x) mean(x) - std.error(x),
               fun.ymax = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun.y = mean, position=position_dodge(width=0.25),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Percent browsed inflorescences")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0,1), legend.position=c(0,1), legend.background = element_blank()) +
  scale_y_continuous(labels = percent)

dev.off()

```

Climate
Garden Park
seasons:   
    Winter: November-January (11-1)      
    Spring: February-April (2-4)   
    Summer: May-July (5-7)   
    Fall: August-October (8-10)   
```{r}
erbr.c$season <- "winter"
erbr.c$season[erbr.c$Month >1 & erbr.c$Month <5] <- "spring"
erbr.c$season[erbr.c$Month >4 & erbr.c$Month <8] <- "summer"
erbr.c$season[erbr.c$Month >7 & erbr.c$Month <11] <- "fall"

erbr.c.summary <- aggregate(cbind(tmin,tmax,ppt)~season+Prev12, 
                            data = erbr.c, mean, na.rm=TRUE)

#cutoff <- 0.65
#cutoff <- 0.75

cutoff <- 0.5

season <- reshape(erbr.c.summary[erbr.c.summary$Prev12 < currentyr+1 &
                                   erbr.c.summary$Prev12 > 1994,],
                  idvar="Prev12",
                  timevar="season",
                  direction="wide")

cor.table<-cor(season[,-1])
data <- as.data.frame(as.table(cor.table))
combins <- combn(colnames(cor.table),2,FUN=function(x) paste(x,collapse="_"))
cor.data <- data[data$Var1 != data$Var2, ]
data <- cor.data[paste(cor.data$Var1, cor.data$Var2, sep="_") %in% combins,]
exclude <- paste(data$Var2[abs(data$Freq)>cutoff],sep=",")

# Correlated
pairs(season[,c(grep(paste(exclude, collapse = "|"),
                     names(season), value = TRUE))])

# Not correlated??
pairs(season[,c(grep(paste(exclude, collapse = "|"),
                     names(season), value = TRUE, invert=TRUE))])


#Which are correlated? 
data[abs(data$Freq)>cutoff,]

tomatch <- c("Prev12",exclude)

forpca <- season[,c(grep(paste(tomatch, collapse="|"),
                         names(season), value=TRUE, invert=TRUE))]
names(forpca)
```

```{r}
erbr.pca <- princomp(forpca,cor=TRUE)
summary(erbr.pca)
erbr.load <- loadings(erbr.pca)
erbr.pc <- predict(erbr.pca)

erbr.pc <- data.frame(erbr.pc,season)
erbr.pc$Drought <- "pre"
erbr.pc$Drought[erbr.pc$Prev12 < 2011] <- "post"

```


```{r}
ggplot(erbr.pc, aes(Comp.1,Comp.2, colour = Drought, label = Prev12))+
  geom_text(alpha = 0.75, angle = 45, size = 3) +
  stat_ellipse()+
  xlab("PC1 (26%)")+
  ylab("PC2 (23%)")+
  theme_bw()
  

```


Figure 6
```{r}
precip <- aggregate(ppt~Prev12,
                    data = erbr.c, sum)

mean(precip$ppt)


jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig6a.jpg",
     width=150, height=130,units='mm', res=300)

ggplot(precip[precip$Prev12>1994&precip$Prev12<=currentyr,], aes(Prev12, ppt))+
  geom_line()+
  geom_hline(linetype = "dashed", aes(yintercept = mean(ppt)))+
  annotate("text", x=1998, y=mean(precip$ppt)-5, label=paste(round(mean(precip$ppt),0),"mm", sep=""))+
  theme_bw()+
  geom_rect(aes(xmin=-Inf,xmax=2003.5,
                ymin=-Inf, ymax=Inf),
            fill= "grey", alpha = 0.03)+
  scale_x_continuous(breaks = seq(1995,currentyr,by = 2))+
  ylab("Annual precipition (mm previous Aug=Jul)")+
  xlab("Survey year")+
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))

dev.off()
```

```{r}
mintemp <- aggregate(tmin~Prev12,
                     data = erbr.c, mean)

mintemp <- mintemp[mintemp$Prev12>1994&mintemp$Prev12<=currentyr,]

meantempmin <- mean(mintemp$tmin)


jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig6b.jpg",
     width=150, height=130,units='mm', res=300)

ggplot(mintemp, aes(Prev12, tmin))+
  geom_line()+
  geom_hline(linetype = "dashed", aes(yintercept = mean(tmin)))+
  annotate("text", x=1995, y=mean(mintemp$tmin)+0.06, label=bquote(.(round(meantempmin,1)))) +
  theme_bw()+
  geom_rect(aes(xmin=-Inf,xmax=2003.5,
                ymin=-Inf, ymax=Inf),
            fill= "grey", alpha = 0.03)+
  scale_x_continuous(breaks = seq(1995,currentyr,by = 2))+  
  ylab(expression("Average maximum temperature ("~degree*C~"previous Aug-Jul)"))+
  xlab("Survey year")+
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))

dev.off()
```

```{r}
maxtemp <- aggregate(tmax~Prev12,
                     data = erbr.c, mean)

maxtemp <- maxtemp[maxtemp$Prev12>1994&maxtemp$Prev12<=currentyr,]
meantempmax <- mean(maxtemp$tmax)



jpeg("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/2018_ErBr/Fig6c.jpg",
     width=150, height=130,units='mm', res=300)


ggplot(maxtemp, aes(Prev12, tmax))+
  geom_line()+
  geom_hline(linetype = "dashed", aes(yintercept = mean(tmax)))+
  annotate("text", x=1994.7, y=mean(maxtemp$tmax)+0.09, 
           label= bquote(.(round(meantempmax,1)))) +   #~degree*C
  theme_bw()+
  geom_rect(aes(xmin=-Inf,xmax=2003.5,
                ymin=-Inf, ymax=Inf),
            fill= "grey", alpha = 0.03)+
  scale_x_continuous(breaks = seq(1995,currentyr,by = 2))+
  ylab(expression("Average maximum temperature ("~degree*C~"previous Aug-Jul)"))+
  xlab("Survey year")+
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))

dev.off()

```


```{r}
erbr.all <- merge(erbr.summary,precip, by.x = "Year", by.y = "Prev12")
erbr.all <- merge(erbr.all, mintemp, by.x = "Year", by.y = "Prev12")
erbr.all <- merge(erbr.all, maxtemp, by.x = "Year", by.y = "Prev12")
```

Transformations
```{r}
#log transformation
hist(erbr.all$SumOfRosettes)
hist(erbr.all$SumOfArea)
hist(erbr.all$SumOfInfl)

hist(log(erbr.all$SumOfRosettes+1))
hist(log(erbr.all$SumOfArea+1))
hist(log(erbr.all$SumOfInfl+1))

erbr.all$logSumOfRosettes <- log(erbr.all$SumOfRosettes+1)
erbr.all$logSumOfArea <- log(erbr.all$SumOfArea+1)
erbr.all$logSumOfInfl <- log(erbr.all$SumOfInfl+1)

#arcsine square root transformation
hist(erbr.all$InflperRos)
hist(erbr.all$RosperArea) #maybe not this one?
hist(erbr.all$InflperArea)
hist(erbr.all$InflBrperInfl)

hist(asin(sqrt(erbr.all$InflperRos)/100))
hist(asin(sqrt(erbr.all$RosperArea)/100)) #not all that much better
hist(asin(sqrt(erbr.all$InflperArea)/100))
hist(asin(sqrt(erbr.all$InflBrperInfl)/100))

erbr.all$sinsqInflperRos <- asin(sqrt(erbr.all$InflperRos)/100)
erbr.all$sinsqInflperArea <- asin(sqrt(erbr.all$InflperArea)/100)
erbr.all$sinsqInflBrperInfl <- asin(sqrt(erbr.all$InflBrperInfl)/100)
```

```{r}
cor(erbr.all$tmin,erbr.all$tmax)
cor(erbr.all[,c("tmin","tmax","ppt")])
pairs(erbr.all[,c("tmin","tmax","ppt")])
```

## Dunno, I think I'll just report a straight lm
log transformed sum of rosettes
```{r}
lmer(logSumOfRosettes ~ tmin + (1|Site), data = erbr.all)

summary(lm(logSumOfRosettes ~ tmin, data = erbr.all))

summary(lm(logSumOfRosettes ~ ppt, data = erbr.all))
```


```{r}
ggplot(erbr.all, aes(tmin, SumOfRosettes, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab(expression("Minimum temperature"~degree*C))+
  ylab("Rosettes per transect")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1)) 

```


```{r}
ggplot(erbr.all, aes(ppt, SumOfRosettes, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Precipitation mm")+
  ylab("Rosettes per transect")+
  theme_bw() +
  ggtitle("") +
  theme(plot.title=element_text(hjust=0))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha(0.4))) 

```


log transformed sum of inflorescences
```{r}
lmer(logSumOfInfl ~ tmin + (1|Site), data = erbr.all)
summary(lm(logSumOfInfl ~ tmin, data = erbr.all))

summary(lm(logSumOfInfl ~ ppt, data = erbr.all))
```


```{r}
ggplot(erbr.all, aes(tmin, logSumOfInfl, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab(expression("Minimum temperature"~degree*C))+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Inflorescences"["  log"]*" per transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha(0.4))) 

```


```{r}
ggplot(erbr.all, aes(ppt, logSumOfInfl, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Precipitation mm")+
  theme_bw() +
  ggtitle("") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Inflorescences"["  log"]*" per transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0.4,1), legend.position=c(0.4,1),
        legend.background = element_rect(fill=alpha(0.2))) 

```

transformed inflorescences per rosette
```{r}
lmer(sinsqInflperRos ~ tmin + (1|Site), data = erbr.all)

summary(lmer(sinsqInflperRos ~ tmin + (1|Site), data = erbr.all))

summary(lm(sinsqInflperRos ~ tmin, data = erbr.all))


summary(lm(sinsqInflperRos ~ ppt, data = erbr.all))
```


```{r}
ggplot(erbr.all, aes(tmin, sinsqInflperRos, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab(expression("Minimum temperature"~degree*C))+
  theme_bw() +
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Inflorescences per rosette"["  arcsine square root"]*" by transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha(0.4))) 

```


```{r}
ggplot(erbr.all, aes(ppt, sinsqInflperRos, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Precipitation mm")+
  theme_bw() +
  ggtitle("") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Inflorescences per rosette"["  arcsine square root"]*" by transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0.4,1), legend.position=c(0.4,1),
        legend.background = element_rect(fill=alpha(0.4))) 

```



transformed browsed inflorescences per total inflor
```{r}
lmer(sinsqInflBrperInfl ~ tmin + (1|Site), data = erbr.all)

summary(lmer(sinsqInflBrperInfl ~ tmin + (1|Site), data = erbr.all))

summary(lm(sinsqInflBrperInfl ~ tmin, data = erbr.all))


summary(lm(sinsqInflBrperInfl ~ ppt, data = erbr.all))
```


```{r}
ggplot(erbr.all, aes(tmin, sinsqInflBrperInfl, colour = Site))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab(expression("Minimum temperature"~degree*C))+
  theme_bw() +
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Proportion of browsed inflorescences"["  arcsine square root"]*" by transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1),
        legend.background = element_rect(fill=alpha(0.4))) 

```




ppt and tmax more than ppt and tmin so keep tmin. but they are 71% so could keep both 
```{r}
erbr.all$ppt100 <- erbr.all$ppt/100
step.lm <- step(lm(logSumOfRosettes ~ (ppt+tmin+tmax)^2, data = erbr.all))

#Check for Multi-collinearity
vif(step.lm) #Variance inflation factors
sqrt(vif(step.lm)) > 2 # means a problem, so all are a problem

#Remove tmax and keep going
twolm <- lm(logSumOfRosettes ~ (ppt+tmin)^2, data = erbr.all)
vif(twolm)

step.lm <- step(lm(logSumOfRosettes ~ (ppt+tmin)^2, data = erbr.all))

summary(step.lm)
```

tmin only signficant one
```{r}
erbr.all$sinsqInflperRos
erbr.all$logSumOfInfl

summary(lm(logSumOfRosettes~tmin, data=erbr.all))

twoInfo <- lm(logSumOfInfl~(ppt+tmin)^2, data=erbr.all)
vif(twoInfo)

summary(lm(logSumOfInfl~tmin, data=erbr.all))

summary(lm(logSumOfInfl~ppt, data=erbr.all))


```


```{r}
step.lmsmall <- step(lm(logSumOfRosettes ~ (ppt+tmin)^2, data = erbr.all))
summary(step.lmsmall)

summary(lm(logSumOfRosettes~tmin, data=erbr.all))
summary(lm(logSumOfRosettes~tmax, data=erbr.all))
summary(lm(logSumOfRosettes~ppt, data=erbr.all))
```

#Precip not signficant but what does it look like?
```{r}
ggplot(erbr.all, aes(ppt, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Total precipitation (previous 12 months)")+
  ylab("Rosettes per transect")

```

```{r}
ggplot(erbr.all, aes(tmin, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab(expression("Minimum temperature"~degree*C))+
  ylab("Rosettes per transect")

```


```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(ppt, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Total precipitation (previous 12 months)")+
  ylab("Rosettes per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmin  <= mean(erbr.all$tmin),], aes(ppt, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Total precipitation (previous 12 months)")+
  ylab("Rosettes per transect")

```


```{r}
ggplot(erbr.all[erbr.all$tmax > mean(erbr.all$tmax),],aes(tmin, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly minimum temperature (previous 12 months)")+
  ylab("Rosettes per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmax <= mean(erbr.all$tmax),], aes(tmin, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly minimum temperature (previous 12 months)")+
  ylab("Rosettes per transect")

```

Maximum temperatre given above and below minimum temperature
```{r}
ggplot(erbr.all[erbr.all$tmin <= mean(erbr.all$tmin),], aes(tmax, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Rosettes per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(tmax, SumOfRosettes))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Rosettes per transect")

```

## Inflorescences
```{r}

ggplot(erbr.all[erbr.all$tmin <= mean(erbr.all$tmin),], aes(tmax, SumOfInfl))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(tmax, SumOfInfl))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per transect")

```


## Inflorescences
```{r}

ggplot(erbr.all[erbr.all$tmin <= mean(erbr.all$tmin),], aes(tmax, SumOfInfl))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per transect")

```

```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(tmax, SumOfInfl))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per transect")

```


#InflperRos
```{r}

ggplot(erbr.all[erbr.all$tmin <= mean(erbr.all$tmin),], aes(tmax, InflperRos))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per rosettes")

```

```{r}
ggplot(erbr.all[erbr.all$tmin > mean(erbr.all$tmin),], aes(tmax, InflperRos))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Average monthly maximum temperature (previous 12 months)")+
  ylab("Inflorescences per rosettes")

```

Appendix D:
```{r}
head(erbr.all)

appdD <- erbr.all[erbr.all$Year == 2016,
                  c("Site","Transect","Year","SumOfRosettes","SumOfInfl","SumOfArea",
                     "SumOfBrowsedInfl","Rust")]
```

For Becky, annual report 01232018
```{r}
erbr_yr <- aggregate(Rosettes~Year, data=erbr.summary, FUN=sum)

ggsave("Q:/Research/MEDL_folder/ErBr_yr.jpg",device="jpeg",
       ggplot(erbr_yr, aes(Year,Rosettes))+
         geom_line(colour="blue")+
         ggtitle("Eriogonum brandegeei")+
         theme_classic()+
         ylab("Total Population"))

write.csv(erbr_yr,"Q:/Research/MEDL_folder/ErBr_yr.csv" )

```
