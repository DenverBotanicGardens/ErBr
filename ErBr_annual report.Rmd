---
title: "ErBr_report"
author: "Michelle DePrenger-Levin"
date: "October 31, 2016"
output: html_document
---
Clean slate
```{r}
rm(list=ls(all=TRUE))

```

###Packages
```{r}
library(prism)
library(ggplot2)
library(raster)
library(plotrix)
library(devtools)
library(RCurl)
library(scales)
library(car)
library(lme4)
require(AICcmodavg)
library(lattice)
library(patchwork)
library(dplyr)
library(tidyr)
library(MASS)
```


Functions   
```{r}
# StagePVA_Function.R
script <- getURL("https://raw.githubusercontent.com/DenverBotanicGardens/ErBr/master/CountPVA.R",
                 ssl.verifypeer = FALSE)
eval(parse(text = script))

currentyr <- as.numeric(format(as.Date(Sys.Date(),format="%Y-%m-%d"), "%Y"))

## After add new climate data once:
# PRISM code is at the very bottom
load(paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",currentyr,"_Eriogonum-brandegeei/erbrseasons.Rdata", sep=""))

load(paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",currentyr,"_Eriogonum-brandegeei/climatelong.Rdata", sep=""))

```

###Data    
Download Raw Data and and Summary Table
<https://research.botanicgardens.org/admin/>
```{r}
# Michelle's path
myUsername <- "deprengm"

erbr.raw <- read.csv(paste("C:/Users/",myUsername,"/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_Data/rawdata_",
                           currentyr,".csv", sep=""))

erbr.summary <- read.csv(paste("C:/Users/",myUsername,"/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_Data/summarytable_",
                           currentyr,".csv", sep=""))

erbr.cleora <- erbr.summary[erbr.summary$Site == "Cleora" & erbr.summary$Year == 2004,]
erbr.summary <- erbr.summary[erbr.summary$Site != "Cleora",]
erbr.summary$Site <- factor(erbr.summary$Site)


#Table 1
erbr.summary[erbr.summary$Year == currentyr,]
tab1out <- erbr.summary[!is.na(erbr.summary$SumOfRosettes),1:8]
tab1out[is.na(tab1out)] <- 0
write.csv(tab1out[order(tab1out$Site, tab1out$Transect, tab1out$Year),],
          file = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/Table1.csv", sep=""))

# Rust in how many years of the total
# total
length(2004:currentyr)
#years with rust
table(erbr.summary$Year[erbr.summary$Rust>0], erbr.summary$Rust[erbr.summary$Rust>0])
```


Demography     
    
    Was "SumOfRosettes"

Figure 2
```{r}
ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_Fig2.jpg", sep=""),
  ggplot(erbr.summary, aes(Year, SumOfRosettes  ,colour = Site, shape = Site))+
    stat_summary(fun = mean, position=position_dodge(width=0.5),
                 fun.min = function(x) mean(x) - std.error(x),
                 fun.max = function(x) mean(x) + std.error(x),
                 geom = "errorbar")+
     stat_summary(fun = mean, position=position_dodge(width=0.5),
                 fun.min = function(x) mean(x) - std.error(x),
                 fun.max = function(x) mean(x) + std.error(x),
                 geom = "point")+
    stat_summary(fun = mean,
                 geom = "line")+
    theme_bw() +
    ylab("Average rosettes per transect")+
    scale_color_manual(values=c("#000000","#7e7e7e"),
                       labels = c("Garden Park East","Garden Park West"))+
    scale_shape_manual(values=c(1,2),
                       labels = c("Garden Park East","Garden Park West"))+
    theme(legend.justification=c(1,1), legend.position=c(0.85,1), legend.background = element_blank()) ,
width=250, height=125,units='mm', dpi=300)
  
```

Count PVA
```{r}
gpe.summary <- aggregate(SumOfRosettes ~ Year,
                         data = erbr.summary[erbr.summary$Site == "Garden Park East",], mean)
gpw.summary <- aggregate(SumOfRosettes ~ Year,
                         data = erbr.summary[erbr.summary$Site == "Garden Park West",], mean)

GPE <- CountPVA(gpe.summary, "Year","SumOfRosettes")
GPW <- CountPVA(gpw.summary, "Year","SumOfRosettes")

sapply(GPE[,1:3], function(x) exp(x))
sapply(GPW[,1:3], function(x) exp(x))

exp(GPE[nrow(GPE),])
exp(GPW[nrow(GPE),])

```

Figure 3a
```{r}

fig3a <- 
  ggplot(erbr.summary, aes(Year, SumOfInfl,colour = Site, shape = Site))+
    stat_summary(fun = mean, position=position_dodge(width=0.5),
                 fun.min = function(x) mean(x) - std.error(x),
                 fun.max = function(x) mean(x) + std.error(x),
                 geom = "errorbar")+
     stat_summary(fun = mean, position=position_dodge(width=0.5),
                 fun.min = function(x) mean(x) - std.error(x),
                 fun.max = function(x) mean(x) + std.error(x),
                 geom = "point")+
    stat_summary(fun = mean, position=position_dodge(width=0.5),
                 geom = "line")+
    theme_bw() +
    ggtitle("a)") +
    theme(plot.title=element_text(hjust=0))+
    ylab("Average inflorescences per transect")+
    scale_color_manual(values=c("#000000","#7e7e7e"),
                       labels = c("Garden Park East","Garden Park West"))+
    scale_shape_manual(values=c(1,2),
                       labels = c("Garden Park East","Garden Park West"))+
    theme(legend.justification=c(1,1), legend.position=c(1,1),legend.background = element_blank())

```

Figure 3b
```{r}

# inflorescences per rosette
erbr.summary$InflperRos <- erbr.summary$SumOfInfl/erbr.summary$SumOfRosettes
erbr.summary$InflperRos[is.na(erbr.summary$InflperRos)] <- 0

fig3b <- ggplot(erbr.summary, aes(Year, InflperRos,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Average inflorescences per rosettes")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 


ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",
                        currentyr,"_Fig3ab.jpg", sep=""), 
       fig3a + fig3b,
 width=200, height=75,units='mm', dpi=300)
```

# Demography
Averages before and after 2011
```{r}
# Garden Park West remained significantly smaller in years after 2011
erbr.summary %>%
  mutate(PrePost2011 = case_when(Year >= 2011 ~ "post",
                                 Year < 2011 ~ "pre")) %>%
  group_by(Site, PrePost2011) %>%
  summarise(Mean = mean(SumOfRosettes), sd= sd(SumOfRosettes))

table(erbr.raw$Site, erbr.raw$Year)

erbr.summary %>%
  filter(SumOfRosettes > 0) %>%
ggplot( aes(Year, SumOfRosettes, color = Site, linetype = as.factor(Transect)))+
  geom_line()+
  geom_point()+
  theme_bw()
```

# Figure 4
```{r}

erbr.summary %>%
  mutate(drought = case_when(Year >= 2011 ~ "post",
                                 Year < 2011 ~ "pre")) %>%
  group_by(Site, drought) %>%
  mutate(SumOfRosettesmean = mean(SumOfRosettes), SD= sd(SumOfRosettes), SE = std.error(SumOfRosettes)) %>%
ggplot( aes(drought,SumOfRosettesmean, colour = Site))+
  geom_point(position = position_dodge(width = 0.1))+
  geom_errorbar(aes(ymax=SumOfRosettesmean + SE, ymin=SumOfRosettesmean - SE), width=0.1, position = position_dodge(width = 0.1))+
  theme_bw()+
  xlab("Drought conditions (2011-2013)")+
  ylab("Average rosettes")+
  scale_color_manual(values=c("black","grey70"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank())

cliamte.long <- climate.long %>%
  group_by(Variable) %>%
  mutate(scale_value = scale(Value))

ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_climate.jpg", sep = ""),
climate.long %>%
  group_by(Variable) %>%
  mutate(scale_value = scale(Value)) %>%
ggplot(  aes(Year, scale_value, color = Variable))+
  geom_line()+
  geom_point()+
  theme_bw()+
  facet_grid(season ~ Variable, scales = "free")+
  ylab("scaled and centered")+
  stat_smooth(method = "lm")+
  scale_color_discrete(guide = "none")+
  ggtitle("a)")+
  geom_hline(yintercept = 0, col="grey30", linetype = "dotted"),
width=250, height=125,units='mm', dpi=300)

summary(lm(Value ~ Year + season, data = climate.long[climate.long$Variable == "vpdmax",]))

ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_climate_studyperiod.jpg", sep = ""),
climate.long %>%
  group_by(Variable) %>%
  mutate(scale_value = scale(Value)) %>%
  filter(Year > 2003) %>%
ggplot(  aes(Year, scale_value, color = Variable))+
  geom_line()+
  geom_point()+
  theme_bw()+
  facet_grid(season ~ Variable, scales = "free")+
  ylab("scaled and centered")+
  stat_smooth(method = "lm")+
  scale_color_discrete(guide = "none")+
  ggtitle("b)")+
  geom_hline(yintercept = 0, col="grey30", linetype = "dotted"),
width=250, height=125,units='mm', dpi=300)
```

Figure 5a
```{r}

fig5a <- ggplot(erbr.summary, aes( Year,SumOfArea,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average basal area (cm"^2~") per transect"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

```

Figure 5b
```{r}

erbr.summary$RosperArea <- erbr.summary$SumOfRosettes/erbr.summary$SumOfArea

# jpeg(paste0("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/",currentyr,"_ErBr/Fig5b.jpg"),
#      width=120, height=100,units='mm', res=300)

fig5b <- ggplot(erbr.summary, aes(Year,RosperArea,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average rosettes per basal area (cm"^2~")"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 

# dev.off()

```

Figure 5c
```{r}

erbr.summary$InflperArea <- erbr.summary$SumOfInfl/erbr.summary$SumOfArea

# jpeg(paste0("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/",currentyr,"_ErBr/Fig5c.jpg"),
#      width=120, height=100,units='mm', res=300)

fig5c <- ggplot(erbr.summary, aes(Year,InflperArea,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.5),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.5),
               geom = "line")+
  theme_bw() +
  ggtitle("c)") +
  theme(plot.title=element_text(hjust=0))+
  ylab(expression("Average inflorescences per basal area (cm"^2~")"))+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 


ggsave(filename = paste("Q:/Research/All_Projects_by_Species/Eriogonum SPECIES/Eriogonum_brandegeei/",currentyr,"_ErBr/Fig5abc.jpg", sep=""), 
       (fig5a | fig5b)/(fig5c | plot_spacer()),
 width=240, height=200,units='mm', dpi=300)

```

Figure 6a
```{r}
erbr.summary %>%
  group_by(Year, Site) %>%
  summarize(mean = mean(SumOfBrowsedInfl, na.rm = TRUE), 
            se = std.error(SumOfBrowsedInfl, na.rm = TRUE)) %>%
  print(n=50)

erbr.summary[erbr.summary$Year == 2020,]

fig6a <- ggplot(erbr.summary, aes(Year,SumOfBrowsedInfl,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.25),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.25),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.25),
               geom = "line")+
  theme_bw() +
  ggtitle("a)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Average browsed inflorescences per transect")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), legend.background = element_blank()) 


```

Figure 6b
```{r}

erbr.summary$InflBrperInfl <- erbr.summary$SumOfBrowsedInfl/erbr.summary$SumOfInfl

fig6b <- ggplot(erbr.summary, aes(Year,InflBrperInfl,colour = Site, shape = Site))+
  stat_summary(fun = mean, position=position_dodge(width=0.25),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "errorbar")+
   stat_summary(fun = mean, position=position_dodge(width=0.25),
               fun.min = function(x) mean(x) - std.error(x),
               fun.max = function(x) mean(x) + std.error(x),
               geom = "point")+
  stat_summary(fun = mean, position=position_dodge(width=0.25),
               geom = "line")+
  theme_bw() +
  ggtitle("b)") +
  theme(plot.title=element_text(hjust=0))+
  ylab("Percent browsed inflorescences")+
  scale_color_manual(values=c("#000000","#7e7e7e"),
                     labels = c("Garden Park East","Garden Park West"))+
  scale_shape_manual(values=c(1,2),
                     labels = c("Garden Park East","Garden Park West"))+
  theme(legend.justification=c(0,1), legend.position=c(0,1), legend.background = element_blank()) +
  scale_y_continuous(labels = percent)


ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_Fig6ab.jpg", sep=""), 
       fig6a + fig6b,
 width=240, height=100,units='mm', dpi=300)
```



```{r}

# Fill in missing years with climate but no data

missingyears <- setdiff(c(min(unique(erbr.summary$Year)):max(unique(erbr.summary$Year))),
                        unique(erbr.summary$Year))

for(yr in missingyears){
  addrows <- erbr.summary[erbr.summary$Year == 2013,]
  addrows[,3:8] <- lapply(addrows[,3:8], function(x) x <- NA)
  addrows$Year <- yr
  erbr.summary <- rbind(erbr.summary, addrows)
}

erbr.all <- merge(erbr.summary,erbr.seasons, by = "Year")
```



## AIC 

# Dredge for everything or: Think through what might be impacting rosettes. Maybe multiple years of drought and rust or just current or just past climate or interaction of a couple years in a row of climate.   
```{r}
library(jtools)
library(lme4)

pairs(erbr.seasons)
cor.climate <- as.data.frame(as.table(cor(erbr.seasons[,-1])))
cor.climate[abs(cor.climate$Freq) > 0.7,]

exclude <- c("ppt_fall","tmax_fall","ppt_summer","tmax_summer","tmax_winter")
keep <- c("vpdmax_fall","vpdmax_summer","tmin_fall","vpdmax_winter")

erbr.all[,!(names(erbr.all) %in% exclude)]
erbr.all$SiteTran <- paste(erbr.all$Site,erbr.all$Transect,sep="")
erbr.lms <- erbr.all[erbr.all$SumOfRosettes >0,!(names(erbr.all) %in% exclude)]

lm1 <- glmer(SumOfRosettes ~ vpdmax_fall + vpdmax_summer + tmin_fall + vpdmax_winter + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm2 <- glmer(SumOfRosettes ~ vpdmax_fall + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm3 <- glmer(SumOfRosettes ~ vpdmax_summer + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm4 <- glmer(SumOfRosettes ~ vpdmax_winter + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm5 <- glmer(SumOfRosettes ~ tmin_fall + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm6 <- glmer(SumOfRosettes ~ 1 + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))


lm.list <- list(lm1,lm6, lm2,lm3,lm4, lm5)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

evidence(lm.results)

## correct standard error? Compare with quasipoisson can't with glmer
# lm1a <- glmer(SumOfRosettes ~ vpdmax_fall + vpdmax_summer + tmin_fall + vpdmax_winter + (1|SiteTran), 
#               data = erbr.lms, family = quasipoisson(link = "log"))
plot_summs(lm1, lm5, scale = TRUE, plot.distributions = TRUE)
effect_plot(lm1, pred = vpdmax_fall, interval = TRUE)
## predictions generated
vpdw <- effect_plot(lm1, pred = vpdmax_winter, 
                    y.label = "Count of Rosettes per transect", 
                    x.label = "Winter vpdmax", interval = TRUE, plot.points = TRUE) ## plots actual data points
tmf <- effect_plot(lm1, pred = tmin_fall, interval = TRUE, plot.points = TRUE)
vpdf <- effect_plot(lm1, pred = vpdmax_fall, interval = TRUE, plot.points = TRUE)
vpds <- effect_plot(lm1, pred = vpdmax_summer, interval = TRUE, plot.points = TRUE)

(vpdw + vpdf) / (vpds + tmf)
```



```{r}
ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_Fig7a.jpg", sep=""),
(plot_summs(lm1, lm5, scale = TRUE, plot.distributions = TRUE)+
  ggtitle("a)"))/
(
erbr.lms %>%
  filter(!is.na(Site)) %>%
ggplot(  aes(vpdmax_winter, SumOfRosettes, color = Site))+
  geom_point()+
  geom_smooth(method = glm,
              method.args = list(family = poisson)) +
  xlab("Winter vpdmax")+
  ylab("Rosettes per transect")+
  theme_bw()+
  ggtitle("b)") +
erbr.lms %>%
  filter(!is.na(Site)) %>%
ggplot(  aes(vpdmax_summer, SumOfRosettes, color = Site))+
  geom_point()+
  geom_smooth(method = glm,
              method.args = list(family = poisson)) +
  xlab("Summer vpdmax")+
  ylab("")+
  theme_bw()+
  ggtitle("c)") ) / 
(
erbr.lms %>%
  filter(!is.na(Site)) %>%
ggplot(  aes(vpdmax_fall, SumOfRosettes, color = Site))+
  geom_point()+
  geom_smooth(method = glm,
              method.args = list(family = poisson))+
  xlab("Fall vpdmax")+
  ylab("Rosettes per transect")+
  theme_bw()+
  ggtitle("d)") +
erbr.lms %>%
  filter(!is.na(Site)) %>%
ggplot(  aes(tmin_fall, SumOfRosettes, color = Site))+
  geom_point()+
  geom_smooth(method = glm,
              method.args = list(family = poisson))+
  xlab("Fall tmin")+
  ylab("")+
  theme_bw()+
  ggtitle("e)")
)
,
width=250, height=250,units='mm', dpi=300)
```


# Amount of reproduction
```{r}

lm1 <- glmer(SumOfInfl ~ vpdmax_fall + vpdmax_summer + tmin_fall + vpdmax_winter + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm2 <- glmer(SumOfInfl ~ vpdmax_fall + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm3 <- glmer(SumOfInfl ~ vpdmax_summer + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm4 <- glmer(SumOfInfl ~ vpdmax_winter + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm5 <- glmer(SumOfInfl ~ tmin_fall + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm6 <- glmer(SumOfInfl ~ 1 + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))


lm.list <- list(lm1,lm6, lm2,lm3,lm4, lm5)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}

evidence(lm.results)

## correct standard error? Compare with quasipoisson can't with glmer
# lm1a <- glmer(SumOfInfl ~ vpdmax_fall + vpdmax_summer + tmin_fall + vpdmax_winter + (1|SiteTran), 
#               data = erbr.lms, family = quasipoisson(link = "log"))
plot_summs(lm1, lm5, scale = TRUE, plot.distributions = TRUE)
effect_plot(lm1, pred = vpdmax_fall, interval = TRUE)
## predictions generated
vpdw <- effect_plot(lm1, pred = vpdmax_winter, 
                    y.label = "Count of Rosettes per transect", 
                    x.label = "Winter vpdmax", interval = TRUE, plot.points = TRUE) ## plots actual data points
tmf <- effect_plot(lm1, pred = tmin_fall, interval = TRUE, plot.points = TRUE)
vpdf <- effect_plot(lm1, pred = vpdmax_fall, interval = TRUE, plot.points = TRUE)
vpds <- effect_plot(lm1, pred = vpdmax_summer, interval = TRUE, plot.points = TRUE)

(vpdw + vpdf) / (vpds + tmf)
```

```{r}
ggsave(filename = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",
                        currentyr,"_Eriogonum-brandegeei/",currentyr,"_Fig8aflowers.jpg", sep=""),
(plot_summs(lm1, lm5, scale = TRUE, plot.distributions = TRUE)+
  ggtitle("a)"))/
(
erbr.lms %>%
  filter(!is.na(Site)) %>%
ggplot(  aes(vpdmax_winter, log(SumOfInfl), color = Site))+
  geom_point()+
  geom_smooth(method = glm,
              method.args = list(family = poisson)) +
  xlab("Winter vpdmax")+
  ylab("log(Inflorescences per transect)")+
  theme_bw()+
  ggtitle("b)") +
erbr.lms %>%
  filter(!is.na(Site)) %>%
ggplot(  aes(vpdmax_summer, log(SumOfInfl), color = Site))+
  geom_point()+
  geom_smooth(method = glm,
              method.args = list(family = poisson)) +
  xlab("Summer vpdmax")+
  ylab("")+
  theme_bw()+
  ggtitle("c)") ) / 
(
erbr.lms %>%
  filter(!is.na(Site)) %>%
ggplot(  aes(vpdmax_fall, log(SumOfInfl), color = Site))+
  geom_point()+
  geom_smooth(method = glm,
              method.args = list(family = poisson))+
  xlab("Fall vpdmax")+
  ylab("log(Inflorescences per transect)")+
  theme_bw()+
  ggtitle("d)") +
erbr.lms %>%
  filter(!is.na(Site)) %>%
ggplot(  aes(tmin_fall, log(SumOfInfl), color = Site))+
  geom_point()+
  geom_smooth(method = glm,
              method.args = list(family = poisson))+
  xlab("Fall tmin")+
  ylab("")+
  theme_bw()+
  ggtitle("e)")
)
,
width=250, height=250,units='mm', dpi=300)
```



## Other set of variables to see if precip differs from temp
```{r}
erbr.all[,!(names(erbr.all) %in% keep)]
erbr.lms <- erbr.all[erbr.all$SumOfRosettes >0,!(names(erbr.all) %in% keep)]

lm1 <- glmer(SumOfRosettes ~ ppt_fall + tmax_winter + tmax_fall + tmax_summer + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm2 <- glmer(SumOfRosettes ~ ppt_fall + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm3 <- glmer(SumOfRosettes ~ tmax_winter + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm4 <- glmer(SumOfRosettes ~ tmax_summer + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm5 <- glmer(SumOfRosettes ~ tmax_fall + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm6 <- glmer(SumOfRosettes ~ 1 + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))


lm.list <- list(lm1,lm6, lm2,lm3,lm4, lm5)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```

```{r}


lm1 <- glmer(SumOfInfl ~ ppt_fall + tmax_winter + tmax_fall + tmax_summer + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm2 <- glmer(SumOfInfl ~ ppt_fall + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm3 <- glmer(SumOfInfl ~ tmax_winter + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm4 <- glmer(SumOfInfl ~ tmax_summer + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm5 <- glmer(SumOfInfl ~ tmax_fall + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))
lm6 <- glmer(SumOfInfl ~ 1 + (1|Site), 
              data = erbr.lms, family = poisson(link = "log"))


lm.list <- list(lm1,lm6, lm2,lm3,lm4, lm5)
lm.names <- as.character(unlist(lapply(lm.list,formula)))
(lm.results <- aictab(lm.list, modnames=lm.names))
#evidence ratio 
for(i in 2:length(lm.list)){
  print(exp(0.5*lm.results$Delta_AICc[i]))
}
```





Appendix D:
```{r}
head(erbr.all)

appdD <- erbr.all[erbr.all$Year == 2016,
                  c("Site","Transect","Year","SumOfRosettes","SumOfInfl","SumOfArea",
                     "SumOfBrowsedInfl","Rust")]
```

For Becky, annual report 01232018
```{r}
erbr_yr <- aggregate(Rosettes~Year, data=erbr.summary, FUN=sum)

ggsave("Q:/Research/MEDL_folder/ErBr_yr.jpg",device="jpeg",
       ggplot(erbr_yr, aes(Year,Rosettes))+
         geom_line(colour="blue")+
         ggtitle("Eriogonum brandegeei")+
         theme_classic()+
         ylab("Total Population"))

write.csv(erbr_yr,"Q:/Research/MEDL_folder/ErBr_yr.csv" )

```




# Climate Data
just use the data downloaded for AsMi
```{r}
prism_set_dl_dir("Q:/Research/All_Projects_by_Species/Astragalus SPECIES/Astragalus_microcymbus/PRISM_asmiclimate")
#Precipitation total, rain and snow
get_prism_monthlys(type="ppt", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)
#Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)
#Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)

get_prism_monthlys(type = "vpdmax", mon = 1:12, keepZip = FALSE, years = (currentyr-1):currentyr)
```
cleanup
```{r}

get_prism_monthlys(type="ppt", mon = 1:7, keepZip = FALSE, years = currentyr)
#Maximum temperature (average)
get_prism_monthlys(type="tmax", mon = 1:7, keepZip = FALSE, years = currentyr)
#Minimum temperature (average)
get_prism_monthlys(type="tmin", mon = 1:7, keepZip = FALSE, years = currentyr)
get_prism_monthlys(type="tmin", mon = 12, keepZip = FALSE, years = 2021)

```


```{r}
erbrlatlong <- data.frame(Lat = 38.5434, Long = -105.2184)

maxs <- prism_archive_subset(type = "tmax", temp_period = "monthly")
mins <- prism_archive_subset(type = "tmin", temp_period = "monthly")
ppt <- prism_archive_subset(type = "ppt", temp_period = "monthly")
wvdm <- prism_archive_subset(type = "vpdmax", temp_period = "monthly")
length(maxs) # 490, 510
length(mins) # 490
length(ppt) # 490

avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(pd_to_file(x))
  data.frame(data = raster::extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = x)
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(pd_to_file(x))
  data.frame(data = raster::extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = x)
})

avgPrecip <- lapply(ppt, function(x){
  rastertemps <- raster(pd_to_file(x))
  data.frame(data = raster::extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = x)
})

avgwvdm <- lapply(wvdm, function(x){
  rastertemps <- raster(pd_to_file(x))
  data.frame(data = raster::extract(rastertemps, erbrlatlong[,c("Long","Lat")]), date = x)
})

mins.avg <- do.call(rbind, avgTemps.min)
maxs.avg <- do.call(rbind, avgTemps.max)
ppt.avg <- do.call(rbind, avgPrecip)
wvdm.avg <- do.call(rbind, avgwvdm)

erbr.climate.monthly <- ppt.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep")  %>%
  ungroup() %>%
  mutate(Value = scale(Value)) %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value) %>%
  dplyr::rename(Year = Prev12)

## Check running up to Prev12
table(erbr.climate.monthly$Year, erbr.climate.monthly$Month)


erbr.climate.monthly.tmin <- mins.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.tmin$Year, erbr.climate.monthly.tmin$Month) # missing December 2021
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") %>%
  ungroup() %>%
  mutate(Value = scale(Value)) %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value) %>%
  dplyr::rename(Year = Prev12)

erbr.climate.monthly.tmax <- maxs.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.tmin$Year, erbr.climate.monthly.tmin$Month) # missing December 2021
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") %>%
  ungroup() %>%
  mutate(Value = scale(Value)) %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value) %>%
  dplyr::rename(Year = Prev12)

erbr.climate.monthly.wvdm <- wvdm.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.wvdm$Year, erbr.climate.monthly.wvdm$Month) 
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") %>%
  ungroup() %>%
  mutate(Value = scale(Value)) %>%
  pivot_wider(names_from = c(Variable,season), values_from = Value) %>%
  dplyr::rename(Year = Prev12)

erbr.seasons <- erbr.climate.monthly %>%
  left_join(erbr.climate.monthly.tmin, by = "Year") %>%
  left_join(erbr.climate.monthly.tmax, by = "Year") %>%
  left_join(erbr.climate.monthly.wvdm, by = "Year") %>%
  filter(Year < 2023 & Year > 2003)

save(erbr.seasons, file = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",currentyr,"_Eriogonum-brandegeei/erbrseasons.Rdata", sep=""))

wbdm.long <- wvdm.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.wvdm$Year, erbr.climate.monthly.wvdm$Month) 
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep")

max.long <- maxs.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.tmin$Year, erbr.climate.monthly.tmin$Month) # missing December 2021
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") 

tmin.long <- mins.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  # table(erbr.climate.monthly.tmin$Year, erbr.climate.monthly.tmin$Month) # missing December 2021
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  # mutate(season = "winter") %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = mean(data), .groups = "keep") 

ppt.long <- ppt.avg %>%
  mutate(Year = as.numeric(substr(date,  (nchar(date)+1)-10,nchar(date)-6)),
         Month = as.numeric(substr(date, (nchar(date)+1)-6, nchar(date)-4)),
         # Make previous 12 months match year (previous to August survey)
         Prev12 = ifelse(Month > 7, Year+1, Year)) %>%
  #extract the climate variable name from the prism long name
  separate(date, sep = "_", into = c(NA,"Variable",NA,NA,NA,NA)) %>%
  mutate(season = case_when(Month %in% c(1:3,12) ~ "winter",
                            Month>=8 & Month<=11 ~ "fall",
                            Month>=4 & Month<=7 ~ "summer")) %>%
  group_by(season, Prev12, Variable) %>%
  dplyr::summarise(Value = sum(data), .groups = "keep")

climate.long <- wbdm.long %>%
  bind_rows(max.long) %>%
  bind_rows(tmin.long) %>%
  bind_rows(ppt.long) %>%
  dplyr::rename(Year = Prev12)

save(climate.long, file = paste("C:/Users/deprengm/Denver Botanic Gardens/Conservation - General/AllProjectsBySpecies/Eriogonum-brandegeei/Eriogonum-brandegeei_AnnualReports/",currentyr,"_Eriogonum-brandegeei/climatelong.Rdata", sep=""))
```

